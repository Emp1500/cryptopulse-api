<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Charts - CryptoPulse</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/chart.css">
  <link rel="stylesheet" href="/css/other.css">
</head>
<body>
  <%- include('partials/header') %>

  <div class="charts-page">
    <div class="charts-header">
      <h1>Live Crypto Charts</h1>
      <p>Real-time price charts with historical data</p>
    </div>

    <div class="charts-grid">
      <!-- Bitcoin Chart -->
      <div class="chart-card" data-coin="bitcoin" data-symbol="BTC" data-color="#f7931a">
        <div class="chart-card-header">
          <div class="coin-title">
            <img src="https://assets.coingecko.com/coins/images/1/small/bitcoin.png" alt="BTC" class="coin-logo">
            <div>
              <h3>Bitcoin</h3>
              <span class="coin-symbol">BTC/USD</span>
            </div>
          </div>
          <div class="price-info">
            <div class="current-price" data-price>--</div>
            <div class="price-change" data-change>--</div>
          </div>
        </div>

        <div class="chart-stats">
          <div class="stat">
            <span class="stat-label">24h High</span>
            <span class="stat-value" data-high>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">24h Low</span>
            <span class="stat-value" data-low>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">24h Volume</span>
            <span class="stat-value" data-volume>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">Market Cap</span>
            <span class="stat-value" data-mcap>--</span>
          </div>
        </div>

        <div class="time-filters">
          <button class="time-btn" data-days="1">1D</button>
          <button class="time-btn" data-days="7">7D</button>
          <button class="time-btn active" data-days="30">30D</button>
          <button class="time-btn" data-days="90">90D</button>
          <button class="time-btn" data-days="365">1Y</button>
        </div>

        <div class="chart-container">
          <div class="chart-loading">
            <div class="spinner"></div>
            <span>Loading chart data...</span>
          </div>
          <canvas class="price-chart"></canvas>
        </div>

        <div class="chart-footer">
          <div class="chart-info">
            <span class="info-dot"></span>
            <span>Price in USD</span>
          </div>
          <div class="data-source">Data: CoinGecko API</div>
        </div>
      </div>

      <!-- Ethereum Chart -->
      <div class="chart-card" data-coin="ethereum" data-symbol="ETH" data-color="#627eea">
        <div class="chart-card-header">
          <div class="coin-title">
            <img src="https://assets.coingecko.com/coins/images/279/small/ethereum.png" alt="ETH" class="coin-logo">
            <div>
              <h3>Ethereum</h3>
              <span class="coin-symbol">ETH/USD</span>
            </div>
          </div>
          <div class="price-info">
            <div class="current-price" data-price>--</div>
            <div class="price-change" data-change>--</div>
          </div>
        </div>

        <div class="chart-stats">
          <div class="stat">
            <span class="stat-label">24h High</span>
            <span class="stat-value" data-high>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">24h Low</span>
            <span class="stat-value" data-low>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">24h Volume</span>
            <span class="stat-value" data-volume>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">Market Cap</span>
            <span class="stat-value" data-mcap>--</span>
          </div>
        </div>

        <div class="time-filters">
          <button class="time-btn" data-days="1">1D</button>
          <button class="time-btn" data-days="7">7D</button>
          <button class="time-btn active" data-days="30">30D</button>
          <button class="time-btn" data-days="90">90D</button>
          <button class="time-btn" data-days="365">1Y</button>
        </div>

        <div class="chart-container">
          <div class="chart-loading">
            <div class="spinner"></div>
            <span>Loading chart data...</span>
          </div>
          <canvas class="price-chart"></canvas>
        </div>

        <div class="chart-footer">
          <div class="chart-info">
            <span class="info-dot"></span>
            <span>Price in USD</span>
          </div>
          <div class="data-source">Data: CoinGecko API</div>
        </div>
      </div>

      <!-- BNB Chart -->
      <div class="chart-card" data-coin="binancecoin" data-symbol="BNB" data-color="#f0b90b">
        <div class="chart-card-header">
          <div class="coin-title">
            <img src="https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png" alt="BNB" class="coin-logo">
            <div>
              <h3>BNB</h3>
              <span class="coin-symbol">BNB/USD</span>
            </div>
          </div>
          <div class="price-info">
            <div class="current-price" data-price>--</div>
            <div class="price-change" data-change>--</div>
          </div>
        </div>

        <div class="chart-stats">
          <div class="stat">
            <span class="stat-label">24h High</span>
            <span class="stat-value" data-high>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">24h Low</span>
            <span class="stat-value" data-low>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">24h Volume</span>
            <span class="stat-value" data-volume>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">Market Cap</span>
            <span class="stat-value" data-mcap>--</span>
          </div>
        </div>

        <div class="time-filters">
          <button class="time-btn" data-days="1">1D</button>
          <button class="time-btn" data-days="7">7D</button>
          <button class="time-btn active" data-days="30">30D</button>
          <button class="time-btn" data-days="90">90D</button>
          <button class="time-btn" data-days="365">1Y</button>
        </div>

        <div class="chart-container">
          <div class="chart-loading">
            <div class="spinner"></div>
            <span>Loading chart data...</span>
          </div>
          <canvas class="price-chart"></canvas>
        </div>

        <div class="chart-footer">
          <div class="chart-info">
            <span class="info-dot"></span>
            <span>Price in USD</span>
          </div>
          <div class="data-source">Data: CoinGecko API</div>
        </div>
      </div>

      <!-- XRP Chart -->
      <div class="chart-card" data-coin="ripple" data-symbol="XRP" data-color="#00aae4">
        <div class="chart-card-header">
          <div class="coin-title">
            <img src="https://assets.coingecko.com/coins/images/44/small/xrp-symbol-white-128.png" alt="XRP" class="coin-logo">
            <div>
              <h3>XRP</h3>
              <span class="coin-symbol">XRP/USD</span>
            </div>
          </div>
          <div class="price-info">
            <div class="current-price" data-price>--</div>
            <div class="price-change" data-change>--</div>
          </div>
        </div>

        <div class="chart-stats">
          <div class="stat">
            <span class="stat-label">24h High</span>
            <span class="stat-value" data-high>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">24h Low</span>
            <span class="stat-value" data-low>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">24h Volume</span>
            <span class="stat-value" data-volume>--</span>
          </div>
          <div class="stat">
            <span class="stat-label">Market Cap</span>
            <span class="stat-value" data-mcap>--</span>
          </div>
        </div>

        <div class="time-filters">
          <button class="time-btn" data-days="1">1D</button>
          <button class="time-btn" data-days="7">7D</button>
          <button class="time-btn active" data-days="30">30D</button>
          <button class="time-btn" data-days="90">90D</button>
          <button class="time-btn" data-days="365">1Y</button>
        </div>

        <div class="chart-container">
          <div class="chart-loading">
            <div class="spinner"></div>
            <span>Loading chart data...</span>
          </div>
          <canvas class="price-chart"></canvas>
        </div>

        <div class="chart-footer">
          <div class="chart-info">
            <span class="info-dot"></span>
            <span>Price in USD</span>
          </div>
          <div class="data-source">Data: CoinGecko API</div>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@1.2.0/dist/chartjs-plugin-crosshair.min.js"></script>

  <script>
    // Chart instances storage
    const chartInstances = new Map();

    // Format currency
    function formatCurrency(value, decimals = 2) {
      if (value >= 1e9) return '$' + (value / 1e9).toFixed(2) + 'B';
      if (value >= 1e6) return '$' + (value / 1e6).toFixed(2) + 'M';
      if (value >= 1e3) return '$' + (value / 1e3).toFixed(2) + 'K';
      return '$' + value.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    // Format large numbers
    function formatNumber(value) {
      if (value >= 1e12) return (value / 1e12).toFixed(2) + 'T';
      if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
      if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
      if (value >= 1e3) return (value / 1e3).toFixed(2) + 'K';
      return value.toLocaleString();
    }

    // Get date format based on time period
    function getDateFormat(days) {
      if (days === 1) {
        return { hour: '2-digit', minute: '2-digit' };
      } else if (days <= 7) {
        return { weekday: 'short', hour: '2-digit' };
      } else if (days <= 90) {
        return { month: 'short', day: 'numeric' };
      } else {
        return { month: 'short', year: '2-digit' };
      }
    }

    // Fetch coin market data
    async function fetchCoinData(coinId) {
      try {
        const response = await fetch(
          `https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&community_data=false&developer_data=false`
        );
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
      } catch (error) {
        console.error(`Error fetching ${coinId} data:`, error);
        return null;
      }
    }

    // Fetch chart data
    async function fetchChartData(coinId, days) {
      try {
        const response = await fetch(
          `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${days}`
        );
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
      } catch (error) {
        console.error(`Error fetching ${coinId} chart:`, error);
        return null;
      }
    }

    // Update price info on card
    function updatePriceInfo(card, data) {
      if (!data) return;

      const price = data.market_data.current_price.usd;
      const change = data.market_data.price_change_percentage_24h;
      const high = data.market_data.high_24h.usd;
      const low = data.market_data.low_24h.usd;
      const volume = data.market_data.total_volume.usd;
      const mcap = data.market_data.market_cap.usd;

      // Update current price
      const priceEl = card.querySelector('[data-price]');
      priceEl.textContent = formatCurrency(price, price < 1 ? 4 : 2);

      // Update price change
      const changeEl = card.querySelector('[data-change]');
      const isPositive = change >= 0;
      changeEl.textContent = `${isPositive ? '+' : ''}${change.toFixed(2)}%`;
      changeEl.className = `price-change ${isPositive ? 'positive' : 'negative'}`;

      // Update stats
      card.querySelector('[data-high]').textContent = formatCurrency(high, high < 1 ? 4 : 2);
      card.querySelector('[data-low]').textContent = formatCurrency(low, low < 1 ? 4 : 2);
      card.querySelector('[data-volume]').textContent = '$' + formatNumber(volume);
      card.querySelector('[data-mcap]').textContent = '$' + formatNumber(mcap);

      // Update info dot color based on price direction
      const infoDot = card.querySelector('.info-dot');
      infoDot.style.backgroundColor = isPositive ? '#2ecc71' : '#e74c3c';
    }

    // Create or update chart
    async function createChart(card, days = 30) {
      const coinId = card.dataset.coin;
      const symbol = card.dataset.symbol;
      const color = card.dataset.color;
      const canvas = card.querySelector('.price-chart');
      const loading = card.querySelector('.chart-loading');
      const ctx = canvas.getContext('2d');

      // Show loading
      loading.style.display = 'flex';
      canvas.style.display = 'none';

      // Destroy existing chart
      if (chartInstances.has(coinId)) {
        chartInstances.get(coinId).destroy();
      }

      // Fetch data
      const chartData = await fetchChartData(coinId, days);

      if (!chartData) {
        loading.innerHTML = '<span class="error">Failed to load data. Please try again.</span>';
        return;
      }

      const prices = chartData.prices;
      const dateFormat = getDateFormat(days);

      // Sample data points for better performance
      const sampleRate = days === 1 ? 1 : days <= 7 ? 2 : days <= 30 ? 4 : days <= 90 ? 8 : 12;
      const sampledPrices = prices.filter((_, i) => i % sampleRate === 0);

      const labels = sampledPrices.map(p => {
        const date = new Date(p[0]);
        return date.toLocaleString('en-US', dateFormat);
      });
      const values = sampledPrices.map(p => p[1]);

      // Calculate min/max for better Y axis
      const minPrice = Math.min(...values);
      const maxPrice = Math.max(...values);
      const padding = (maxPrice - minPrice) * 0.1;

      // Create gradient
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, color + '40');
      gradient.addColorStop(1, color + '05');

      // Hide loading, show canvas
      loading.style.display = 'none';
      canvas.style.display = 'block';

      // Create chart
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `${symbol} Price`,
            data: values,
            borderColor: color,
            backgroundColor: gradient,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: color,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(30, 42, 58, 0.95)',
              titleColor: '#fff',
              bodyColor: '#c9d1d9',
              borderColor: color,
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const value = context.raw;
                  return `${symbol}: ${formatCurrency(value, value < 1 ? 6 : 2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              grid: {
                display: true,
                color: 'rgba(48, 54, 61, 0.5)',
                drawBorder: false
              },
              ticks: {
                color: '#8b949e',
                font: {
                  size: 11
                },
                maxRotation: 0,
                maxTicksLimit: days <= 7 ? 7 : 8,
                callback: function(value, index, values) {
                  // Show fewer labels for cleaner look
                  if (values.length > 10) {
                    const step = Math.ceil(values.length / 8);
                    return index % step === 0 ? this.getLabelForValue(value) : '';
                  }
                  return this.getLabelForValue(value);
                }
              }
            },
            y: {
              display: true,
              position: 'right',
              grid: {
                display: true,
                color: 'rgba(48, 54, 61, 0.5)',
                drawBorder: false
              },
              min: minPrice - padding,
              max: maxPrice + padding,
              ticks: {
                color: '#8b949e',
                font: {
                  size: 11
                },
                maxTicksLimit: 6,
                callback: function(value) {
                  if (value >= 1000) {
                    return '$' + (value / 1000).toFixed(1) + 'K';
                  } else if (value >= 1) {
                    return '$' + value.toFixed(0);
                  } else {
                    return '$' + value.toFixed(4);
                  }
                }
              }
            }
          },
          elements: {
            line: {
              capBezierPoints: true
            }
          }
        }
      });

      chartInstances.set(coinId, chart);
    }

    // Initialize all charts
    async function initializeCharts() {
      const cards = document.querySelectorAll('.chart-card');

      for (let i = 0; i < cards.length; i++) {
        const card = cards[i];
        const coinId = card.dataset.coin;

        // Fetch and display coin data
        const coinData = await fetchCoinData(coinId);
        updatePriceInfo(card, coinData);

        // Create chart with delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 300));
        await createChart(card, 30);

        // Set up time filter buttons
        const timeButtons = card.querySelectorAll('.time-btn');
        timeButtons.forEach(btn => {
          btn.addEventListener('click', async function() {
            // Update active state
            timeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Recreate chart with new time period
            await createChart(card, parseInt(this.dataset.days));
          });
        });
      }
    }

    // Start initialization when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeCharts);

    // Refresh data every 60 seconds
    setInterval(async () => {
      const cards = document.querySelectorAll('.chart-card');
      for (const card of cards) {
        const coinId = card.dataset.coin;
        const coinData = await fetchCoinData(coinId);
        updatePriceInfo(card, coinData);
        await new Promise(resolve => setTimeout(resolve, 500));
      }
    }, 60000);
  </script>
</body>
</html>
